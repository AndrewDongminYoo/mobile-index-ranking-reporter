{% extends "base.html" %}
{% load static %}
{% block title %}STATISTIC{% endblock %}
{% block content %}
    <main id="root">
        <div class="flake-ui bordered card-body">
            <form method="post">
                {% csrf_token %}
                <div class="flake-ui input dark small round input-group mh-3 mv-3 bg-dark text-white search">
                    <input
                            id="search-input"
                            placeholder="앱 이름 or 패키지 명"
                            type="text"
                            class="form-control bg-dark text-white"
                            aria-label="Text input with dropdown button">
                    <button class="btn btn-outline-secondary" type="button" id="button-addon2"
                            onclick="searchInModal()">Search
                    </button>
                </div>
                <p class="description">검색하실 앱 또는 퍼블리셔 명을 2글자 이상 입력하시고 <b>검색</b>버튼을 눌러주세요.</p>
            </form>
        </div>
        <table class="flake-ui table second small rect use-selection bordered "
               style="border-radius: 0.25rem;">
            <thead>
            <tr>
                <th scope="col">
                    <div>앱 아이콘
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
                <th scope="col">
                    <div>앱 이름
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
                <th scope="col">
                    <div>날짜
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
                <th scope="col">
                    <div>스토어
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
                <th scope="col">
                    <div>앱 타입
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
                <th scope="col">
                    <div>순위 타입
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
                <th scope="col">
                    <div>기간
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
                <th scope="col">
                    <div>순위
                        <div class="column-sort">
                        </div>
                    </div>
                </th>
            </tr>
            </thead>
            <tbody id="my-rank-table-body">
            </tbody>
        </table>
    </main>
    {% include "includes/modal.html" %}
{% endblock %}
{% block script %}
    <script>
        $(window).keydown(function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                searchInModal();
            }
        })

        const searchInModal = () => {
            let query = $("#search-input").val()
            $("div.modal-body tbody").empty()
            axios.post(`/api/ranking?query=${query}`)
                .then((res) => {
                    $("#staticBackdrop")?.modal("show")
                    _.forEach(res.data.items, (item) => {
                    let {id, app_name, icon_url, package_name} = item
                    let link = parseInt(package_name)
                        ? `https://m.onestore.co.kr/mobilepoc/apps/appsDetail.omp?prodId=${package_name}`
                        : `https://play.google.com/store/apps/details?id=${package_name}`
                    let template = `<tr>
                        <td class="center"><img src="${icon_url}" width="36" height="36" alt="${app_name}"></td>
                        <td class="left"><a href="${link}">${app_name}</a></td>
                        <td class="left">${package_name}</td>
                        <td class="center">
                            <button onclick="track('${app_name}')"
                            >추적</button>
                        </td></tr>`
                    $("div.modal-body tbody").append(template)
                })})
        }

        const rankType = rankString => {
            if (rankString === "gross") return "매출"
            if (rankString === "free") return "무료"
            if (rankString === "paid") return "유료"
        }

        const getLink = (marketString, packageName) => {
            if (marketString === "one") {
                return `https://m.onestore.co.kr/mobilepoc/apps/appsDetail.omp?prodId=${packageName}`
            } else if (marketString === "apple") {
                return `https://www.similarweb.com/app/app-store/${packageName}/statistics/`
            } else if (marketString === "google") {
                return `https://play.google.com/store/apps/details?id=${packageName}`
            }
            return "#"
        }

        axios.get(`/api/follow?sort=created_at&reverse=true&limit=100&offset=0`)
            .then(res => {
                $("tbody#my-rank-table-body").empty()
                return res.data.items
            }).then(items => _.forEach(items, (item) => {
            let {app} = item
            axios.post(`/api/app-detail?app_id=${app}`)
                .then(res => res.data.items)
                .then((appDatas) => {
                        $("tbody#my-rank-table-body").append(`<tr style="border-width: 5px;"></tr>`)
                        _.forEach(appDatas, (appData) => {
                            let {
                                app_name,
                                rank,
                                app_type,
                                created_at,
                                deal_type,
                                icon_url,
                                market,
                                package_name,
                                rank_type
                            } = appData;
                            let template = `<tr>
                            <td class="center"><img alt="app-icon" class="app-icon" width="38" height="38" src="${icon_url}">
                            </td><td class="left"><a href="${getLink(market, package_name)}" class="app-name">${app_name}</a></td>
                            <td><span>${moment(created_at).format("YY.MM.DD. hh:mm:ss")}</span></td>
                            <td class="center"><div class="markets">{__market__}</div></td>
                            <td class="center">${app_type === "app" ? "앱" : "게임"}</td>
                            <td class="center">${rankType(rank_type)}</td>
                            <td class="center">${deal_type === "market_rank" ? "일간" : "실시간"}</td>
                            <td class="center">${rank.toString() + "위"}</td> </tr>`
                            if (market === "google") {
                                $("tbody#my-rank-table-body").append(template.replace("{__market__}", Google))
                            } else if (market === "apple") {
                                $("tbody#my-rank-table-body").append(template.replace("{__market__}", Apple))
                            } else if (market === "one") {
                                $("tbody#my-rank-table-body").append(template.replace("{__market__}", oneStore))
                            }
                        })
                    }
                )
        }))
    </script>
{% endblock %}
